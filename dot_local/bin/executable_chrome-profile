#!/bin/bash
set -uo pipefail

# Chrome Profile Launcher (macOS)
# Opens or focuses a Chrome window with the specified profile
#
# Usage: chrome-profile <profile-directory>
# Example:
#   chrome-profile "Profile 1"
#   chrome-profile Default

if [[ $# -lt 1 ]]; then
  echo "Usage: $(basename "$0") <profile-directory>" >&2
  exit 1
fi

PROFILE_DIR="$1"
CHROME_DATA_DIR="$HOME/Library/Application Support/Google/Chrome"

# Verify profile exists
if [[ ! -d "$CHROME_DATA_DIR/$PROFILE_DIR" ]]; then
  echo "Profile not found: $PROFILE_DIR" >&2
  echo "Available profiles:" >&2
  find "$CHROME_DATA_DIR" -maxdepth 1 -type d \( -name "Default" -o -name "Profile *" \) -exec basename {} \; 2>/dev/null >&2
  exit 1
fi

# Get profile name from Local State
PROFILE_NAME=$(python3 -c "
import json
try:
    with open('$CHROME_DATA_DIR/Local State', 'r') as f:
        data = json.load(f)
    info = data.get('profile', {}).get('info_cache', {}).get('$PROFILE_DIR', {})
    print(info.get('name', '$PROFILE_DIR'))
except:
    print('$PROFILE_DIR')
" 2>/dev/null)

osascript <<EOF
tell application "System Events"
    set chromeRunning to (name of processes) contains "Google Chrome"
end tell

if chromeRunning then
    tell application "Google Chrome"
        activate
    end tell

    tell application "System Events"
        tell process "Google Chrome"
            try
                click menu bar item "Profiles" of menu bar 1
                delay 0.3
                click menu item "${PROFILE_NAME}" of menu "Profiles" of menu bar 1
                return
            on error
                key code 53 -- Escape
            end try
        end tell
    end tell
end if

do shell script "open -na 'Google Chrome' --args --profile-directory='${PROFILE_DIR}'"
EOF
